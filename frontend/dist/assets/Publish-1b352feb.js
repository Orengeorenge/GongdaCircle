import{u as Le,r as p,a as Pe,g as Be,E as r,b as u,o as d,c as v,e as o,w as s,d as i,f as c,i as V,t as y,j as _,F as O,h as N,k as Ie,n as Re,l as Me}from"./index-e807a5c3.js";import{A as Ee}from"./AppHeader-c9079225.js";import{p as q}from"./post-2ee5c828.js";import{_ as Te,g as G,i as ze}from"./_plugin-vue_export-helper-608cf584.js";const je={class:"publish-container"},Fe={class:"container"},Ae={class:"publish-wrapper"},Oe={class:"card publish-card"},Ne={class:"publish-header"},qe={class:"upload-section"},De={key:0,class:"upload-progress"},Ke={class:"progress-text"},We=["src"],$e={key:1,class:"upload-actions"},He={class:"upload-section"},Se={key:0,class:"upload-progress"},Ge={class:"progress-text"},Je={key:1,class:"video-preview"},Qe=["src"],Xe={key:2,class:"upload-actions"},Ye={class:"tags-input"},Ze={class:"popular-tags"},el={class:"publish-settings"},ll={class:"action-buttons"},tl={class:"card preview-card"},ol={class:"preview-content"},sl={class:"preview-post"},al={class:"preview-header"},nl={class:"preview-user"},il={class:"username"},rl={class:"preview-body"},ul={key:0,class:"preview-title"},dl={key:1,class:"preview-text"},pl={key:2,class:"preview-tags"},cl={key:3,class:"preview-location"},vl={__name:"Publish",setup(_l){const x=Le(),B=p(),D=p(),R=p(!1),M=p(!1),C=p(""),f=p([]),b=p([]),E=p(!1),K=p(""),k=p(0),U=p(0),L=p(""),T=p(!1),z=p(!1),h=p([]),j=p(""),F=p({nickname:"工大学子",avatar:""}),l=Pe({type:1,title:"",content:"",tags:[],location:"",linkUrl:"",isTop:!1,allowComment:!0,images:"",video:""}),J={content:[{required:!0,message:"请输入内容",trigger:"blur"},{max:5e3,message:"内容不能超过5000个字符",trigger:"blur"}],title:[{max:200,message:"标题不能超过200个字符",trigger:"blur"}],linkUrl:[{type:"url",message:"请输入正确的链接地址",trigger:"blur"}],images:[{required:!1,validator:(t,e,n)=>{l.type===2&&!e&&f.value.length===0?n(new Error("请上传至少一张图片")):n()},trigger:"change"}],video:[{required:!1,validator:(t,e,n)=>{l.type===3&&!e?n(new Error("请上传视频")):n()},trigger:"change"}]},Q=p(["工大校园","学习心得","社团活动","美食推荐","求职经验","运动健身","旅行分享","技术交流","生活感悟","校园生活"]),X=()=>{x.go(-1)},Y=t=>{t!==4&&(l.linkUrl=""),t!==2&&(f.value=[],h.value=[],l.images=""),t!==3&&(b.value=[],L.value="",j.value="",l.video="")},Z=()=>{M.value=!0,Re(()=>{var t,e;(e=(t=D.value)==null?void 0:t.input)==null||e.focus()})},W=()=>{C.value&&!l.tags.includes(C.value)&&l.tags.push(C.value),M.value=!1,C.value=""},ee=t=>{const e=l.tags.indexOf(t);e>-1&&l.tags.splice(e,1)},le=t=>{l.tags.includes(t)||l.tags.push(t)},te=t=>{K.value=t.url||URL.createObjectURL(t.raw),E.value=!0},oe=(t,e)=>{if(console.log("移除图片:",t),t.url&&h.value.includes(t.url)){const n=h.value.indexOf(t.url);n>-1&&(h.value.splice(n,1),l.images=h.value.join(","))}},se=t=>{const e=t.type.startsWith("image/"),n=t.size/1024/1024<5;return e?n?!0:(r.error("图片大小不能超过5MB!"),!1):(r.error("只能上传图片文件!"),!1)},ae=t=>{const e=t.type.startsWith("video/"),n=t.size/1024/1024<100;return e?n?(L.value=URL.createObjectURL(t.raw||t),!0):(r.error("视频大小不能超过100MB!"),!1):(r.error("只能上传视频文件!"),!1)},ne=t=>{t.status==="ready"&&(b.value=[t],L.value=URL.createObjectURL(t.raw))},ie=async()=>{if(f.value.length===0){r.warning("请先选择要上传的图片");return}T.value=!0,k.value=0,h.value=[];try{for(let t=0;t<f.value.length;t++){const e=f.value[t].raw;e&&(k.value=Math.round(t/f.value.length*50),await re(e))}l.images=h.value.join(","),r.success("图片上传成功")}catch(t){console.error("上传图片出错:",t),r.error("上传图片失败: "+(t.message||"网络错误"))}finally{T.value=!1,k.value=0}},re=async t=>{try{const e=await q.uploadImage(t,n=>{k.value=n});if(e.code===200&&e.data)return h.value.push(e.data),e.data;throw new Error(e.message||"上传失败")}catch(e){throw console.error("上传图片失败:",e),e}},ue=async()=>{if(b.value.length===0){r.warning("请先选择要上传的视频");return}z.value=!0,U.value=0;try{const t=b.value[0].raw;if(!t)throw new Error("无效的视频文件");const e=await q.uploadVideo(t,n=>{U.value=n});if(e.code===200&&e.data)j.value=e.data,l.video=e.data,r.success("视频上传成功");else throw new Error(e.message||"上传失败")}catch(t){console.error("上传视频出错:",t),r.error("上传视频失败: "+(t.message||"网络错误"))}finally{z.value=!1,U.value=0}},de=()=>{l.linkUrl&&console.log("解析链接:",l.linkUrl)},pe=()=>{r.success("草稿保存成功")},ce=()=>l.type===2&&!l.images?(r.warning("请先上传图片"),!1):l.type===3&&!l.video?(r.warning("请先上传视频"),!1):!0,ve=async()=>{if(B.value){if(!ze()){r.error("请先登录后再发布"),x.push("/login");return}ce()&&await B.value.validate(async(t,e)=>{if(t){R.value=!0;try{const n=G();if(!n||!n.id){r.error("无法获取当前用户信息，请重新登录"),x.push("/login");return}const w={title:l.title||"",content:l.content,tags:l.tags.join(","),type:l.type,location:l.location||"",userId:n.id};l.type===2?w.images=l.images:l.type===3?w.video=l.video:l.type===4&&(w.linkUrl=l.linkUrl),console.log("准备发布帖子:",w);const m=await q.createPost(w);m.code===200?(r.success("发布成功！"),Me.confirm("发布成功！是否返回首页查看?","发布成功",{confirmButtonText:"返回首页",cancelButtonText:"继续发布",type:"success"}).then(()=>{x.push("/home")}).catch(()=>{_e()})):m.code===401?(r.error("登录已过期，请重新登录"),x.push("/login")):r.error(m.message||"发布失败")}catch(n){console.error("发布错误:",n);const w=n.message||"发布失败，请检查网络连接";r.error(w)}finally{R.value=!1}}else console.log("表单验证失败:",e),r.error("请完善表单信息")})}},_e=()=>{var t;l.type=1,l.title="",l.content="",l.tags=[],l.location="",l.linkUrl="",l.images="",l.video="",f.value=[],b.value=[],h.value=[],j.value="",L.value="",(t=B.value)==null||t.resetFields()};return Be(()=>{const t=G();t?F.value=t:(r.warning("请先登录后再发布内容"),x.push("/login"))}),(t,e)=>{const n=u("el-button"),w=u("EditPen"),m=u("el-icon"),I=u("el-radio-button"),me=u("Picture"),fe=u("VideoCamera"),ge=u("Link"),ye=u("el-radio-group"),g=u("el-form-item"),P=u("el-input"),he=u("Plus"),$=u("el-upload"),H=u("el-progress"),we=u("el-dialog"),be=u("Upload"),A=u("el-tag"),S=u("el-checkbox"),ke=u("el-form"),Ve=u("el-avatar"),Ue=u("Location"),xe=u("el-main");return d(),v("div",je,[o(Ee),o(xe,{class:"main-content"},{default:s(()=>[i("div",Fe,[i("div",Ae,[i("div",Oe,[i("div",Ne,[e[11]||(e[11]=i("h2",null,"发布新动态",-1)),o(n,{onClick:X},{default:s(()=>e[10]||(e[10]=[c("返回")])),_:1,__:[10]})]),o(ke,{ref_key:"publishFormRef",ref:B,model:l,rules:J,"label-position":"top"},{default:s(()=>[o(g,{label:"动态类型"},{default:s(()=>[o(ye,{modelValue:l.type,"onUpdate:modelValue":e[0]||(e[0]=a=>l.type=a),onChange:Y},{default:s(()=>[o(I,{label:1},{default:s(()=>[o(m,null,{default:s(()=>[o(w)]),_:1}),e[12]||(e[12]=c(" 文字 "))]),_:1,__:[12]}),o(I,{label:2},{default:s(()=>[o(m,null,{default:s(()=>[o(me)]),_:1}),e[13]||(e[13]=c(" 图片 "))]),_:1,__:[13]}),o(I,{label:3},{default:s(()=>[o(m,null,{default:s(()=>[o(fe)]),_:1}),e[14]||(e[14]=c(" 视频 "))]),_:1,__:[14]}),o(I,{label:4},{default:s(()=>[o(m,null,{default:s(()=>[o(ge)]),_:1}),e[15]||(e[15]=c(" 链接 "))]),_:1,__:[15]})]),_:1},8,["modelValue"])]),_:1}),o(g,{label:"标题",prop:"title"},{default:s(()=>[o(P,{modelValue:l.title,"onUpdate:modelValue":e[1]||(e[1]=a=>l.title=a),placeholder:"给你的动态起个标题吧（可选）",maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1}),o(g,{label:"内容",prop:"content"},{default:s(()=>[o(P,{modelValue:l.content,"onUpdate:modelValue":e[2]||(e[2]=a=>l.content=a),type:"textarea",placeholder:"分享你的想法...",rows:8,maxlength:"5000","show-word-limit":"",resize:"none"},null,8,["modelValue"])]),_:1}),l.type===2?(d(),V(g,{key:0,label:"图片",prop:"images"},{default:s(()=>[i("div",qe,[o($,{"file-list":f.value,"onUpdate:fileList":e[3]||(e[3]=a=>f.value=a),action:"#","list-type":"picture-card","auto-upload":!1,limit:9,"on-preview":te,"on-remove":oe,"before-upload":se},{default:s(()=>[o(m,null,{default:s(()=>[o(he)]),_:1})]),_:1},8,["file-list"]),k.value>0&&k.value<100?(d(),v("div",De,[o(H,{percentage:k.value},null,8,["percentage"]),i("div",Ke,"正在上传图片："+y(k.value)+"%",1)])):_("",!0),o(we,{modelValue:E.value,"onUpdate:modelValue":e[4]||(e[4]=a=>E.value=a),title:"图片预览"},{default:s(()=>[i("img",{"w-full":"",src:K.value,alt:"预览图片",style:{"max-width":"100%"}},null,8,We)]),_:1},8,["modelValue"]),e[17]||(e[17]=i("div",{class:"upload-tip"}," 最多上传9张图片，支持 jpg、png、gif 格式，每张图片不超过5MB ",-1)),f.value.length>0?(d(),v("div",$e,[o(n,{type:"primary",size:"small",onClick:ie,loading:T.value},{default:s(()=>e[16]||(e[16]=[c(" 上传图片 ")])),_:1,__:[16]},8,["loading"])])):_("",!0)])]),_:1})):_("",!0),l.type===3?(d(),V(g,{key:1,label:"视频",prop:"video"},{default:s(()=>[i("div",He,[o($,{action:"#",limit:1,"auto-upload":!1,"before-upload":ae,"on-change":ne,"file-list":b.value},{default:s(()=>[o(n,{type:"primary",disabled:b.value.length>=1},{default:s(()=>[o(m,null,{default:s(()=>[o(be)]),_:1}),e[18]||(e[18]=c(" 选择视频 "))]),_:1,__:[18]},8,["disabled"])]),_:1},8,["file-list"]),U.value>0&&U.value<100?(d(),v("div",Se,[o(H,{percentage:U.value},null,8,["percentage"]),i("div",Ge,"正在上传视频："+y(U.value)+"%",1)])):_("",!0),L.value?(d(),v("div",Je,[i("video",{controls:"",src:L.value,style:{"max-width":"100%","max-height":"300px"}},null,8,Qe)])):_("",!0),e[20]||(e[20]=i("div",{class:"upload-tip"}," 支持 mp4、mov、avi 格式，大小不超过100MB ",-1)),b.value.length>0?(d(),v("div",Xe,[o(n,{type:"primary",size:"small",onClick:ue,loading:z.value},{default:s(()=>e[19]||(e[19]=[c(" 上传视频 ")])),_:1,__:[19]},8,["loading"])])):_("",!0)])]),_:1})):_("",!0),l.type===4?(d(),V(g,{key:2,label:"链接地址",prop:"linkUrl"},{default:s(()=>[o(P,{modelValue:l.linkUrl,"onUpdate:modelValue":e[5]||(e[5]=a=>l.linkUrl=a),placeholder:"请输入链接地址",onBlur:de},null,8,["modelValue"])]),_:1})):_("",!0),o(g,{label:"话题标签"},{default:s(()=>[i("div",Ye,[(d(!0),v(O,null,N(l.tags,a=>(d(),V(A,{key:a,closable:"",onClose:Ce=>ee(a),class:"tag-item"},{default:s(()=>[c(" #"+y(a),1)]),_:2},1032,["onClose"]))),128)),M.value?(d(),V(P,{key:0,ref_key:"inputRef",ref:D,modelValue:C.value,"onUpdate:modelValue":e[6]||(e[6]=a=>C.value=a),size:"small",onKeyup:Ie(W,["enter"]),onBlur:W,class:"tag-input"},null,8,["modelValue"])):(d(),V(n,{key:1,size:"small",onClick:Z,class:"add-tag-btn"},{default:s(()=>e[21]||(e[21]=[c(" + 添加话题 ")])),_:1,__:[21]}))]),i("div",Ze,[e[22]||(e[22]=i("span",{class:"popular-tags-title"},"热门话题：",-1)),(d(!0),v(O,null,N(Q.value,a=>(d(),V(A,{key:a,onClick:Ce=>le(a),class:"popular-tag",effect:"plain"},{default:s(()=>[c(" #"+y(a),1)]),_:2},1032,["onClick"]))),128))])]),_:1}),o(g,{label:"位置"},{default:s(()=>[o(P,{modelValue:l.location,"onUpdate:modelValue":e[7]||(e[7]=a=>l.location=a),placeholder:"你在哪里？（可选）","prefix-icon":"Location"},null,8,["modelValue"])]),_:1}),o(g,{label:"发布设置"},{default:s(()=>[i("div",el,[o(S,{modelValue:l.isTop,"onUpdate:modelValue":e[8]||(e[8]=a=>l.isTop=a)},{default:s(()=>e[23]||(e[23]=[c("设为置顶")])),_:1,__:[23]},8,["modelValue"]),o(S,{modelValue:l.allowComment,"onUpdate:modelValue":e[9]||(e[9]=a=>l.allowComment=a)},{default:s(()=>e[24]||(e[24]=[c("允许评论")])),_:1,__:[24]},8,["modelValue"])])]),_:1}),o(g,null,{default:s(()=>[i("div",ll,[o(n,{onClick:pe},{default:s(()=>e[25]||(e[25]=[c("保存草稿")])),_:1,__:[25]}),o(n,{type:"primary",loading:R.value,onClick:ve},{default:s(()=>e[26]||(e[26]=[c(" 发布动态 ")])),_:1,__:[26]},8,["loading"])])]),_:1})]),_:1},8,["model"])]),i("div",tl,[e[28]||(e[28]=i("h3",null,"预览",-1)),i("div",ol,[i("div",sl,[i("div",al,[o(Ve,{size:32},{default:s(()=>{var a;return[c(y((a=F.value.nickname)==null?void 0:a.charAt(0)),1)]}),_:1}),i("div",nl,[i("div",il,y(F.value.nickname),1),e[27]||(e[27]=i("div",{class:"time"},"刚刚",-1))])]),i("div",rl,[l.title?(d(),v("h4",ul,y(l.title),1)):_("",!0),l.content?(d(),v("p",dl,y(l.content),1)):_("",!0),l.tags.length?(d(),v("div",pl,[(d(!0),v(O,null,N(l.tags,a=>(d(),V(A,{key:a,size:"small"},{default:s(()=>[c(" #"+y(a),1)]),_:2},1024))),128))])):_("",!0),l.location?(d(),v("div",cl,[o(m,null,{default:s(()=>[o(Ue)]),_:1}),c(" "+y(l.location),1)])):_("",!0)])])])])])])]),_:1})])}}},hl=Te(vl,[["__scopeId","data-v-57dc4e74"]]);export{hl as default};
