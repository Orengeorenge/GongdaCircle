import{r as U,a as N,b as p,o as P,c as k,d as c,e as a,w as t,f as h,E as f,t as O,q as C,s as z,F as L,h as J,v as Y,g as T,n as $,i as j,j as E,x as D,y as W,z as Z}from"./index-e807a5c3.js";import{r as A,_ as F,a as I,g as B}from"./_plugin-vue_export-helper-608cf584.js";import{A as H}from"./AppHeader-c9079225.js";const S={getCurrentUser:()=>A.get("/auth/me"),updateUserInfo:(_,s)=>{if(!_)return console.error("更新用户信息: 缺少用户名参数"),Promise.reject(new Error("缺少用户名参数"));const u=String(_).trim();console.log("更新用户API: 用户名:",u);const i={username:s.username||"",nickname:s.nickname||"",email:s.email||"",...s.phone?{phone:s.phone}:{},gender:s.gender!==void 0?s.gender:2,birthday:s.birthday||"",school:s.school||"",major:s.major||"",grade:s.grade||"",biography:s.biography||""};return console.log(`准备更新用户信息: 用户名=${u}`,i),A.put(`/user/${u}/profile`,i)},updateAvatar:(_,s)=>_?A.put(`/user/${_}/avatar`,{avatar:s}):(console.error("更新头像: 缺少用户名参数"),Promise.reject(new Error("缺少用户名参数"))),changePassword:(_,s)=>_?(console.log("修改密码API被调用:",{username:_,data:s}),A.put(`/user/${_}/password`,s).then(u=>(console.log("修改密码响应:",u),u.data)).catch(u=>{throw console.error("修改密码API错误:",u),u})):(console.error("修改密码: 缺少用户名参数"),Promise.reject(new Error("缺少用户名参数"))),getUserInfo:_=>{if(!_)return console.error("获取用户信息: 缺少用户名参数"),Promise.reject(new Error("缺少用户名参数"));const s=String(_).trim();return console.log(`获取用户信息: 用户名=${s}`),A.get(`/user/${s}`)}};const G={class:"card"},K={__name:"BasicInfo",setup(_,{expose:s}){const u=U(),i=U(!1),r=N({id:"",username:"",nickname:"",email:"",phone:"",gender:2,birthday:"",school:"",major:"",grade:"",biography:""}),x={nickname:[{required:!0,message:"请输入昵称",trigger:"blur"},{min:2,max:20,message:"昵称长度在 2 到 20 个字符",trigger:"blur"}],email:[{required:!0,message:"请输入邮箱",trigger:"blur"},{type:"email",message:"请输入正确的邮箱格式",trigger:"blur"}],phone:[{pattern:/^1[3-9]\d{9}$/,message:"请输入正确的手机号",trigger:"blur"}]},V=async()=>{if(u.value)try{await u.value.validate(async o=>{var e;if(o){i.value=!0;const d=r.username;if(!d){f.error("无法获取用户名，请重新登录"),i.value=!1;return}console.log("更新用户信息使用的用户名:",d);const l={username:r.username,password:"Password123",nickname:r.nickname,email:r.email,...r.phone&&r.phone.trim()!==""?{phone:r.phone}:{},gender:r.gender,birthday:r.birthday,school:r.school,major:r.major,grade:r.grade,biography:r.biography};console.log("将要提交的用户数据:",l);try{const n=await S.updateUserInfo(d,l);if(console.log("API响应:",n),n&&n.data&&n.data.code===200){if(n.data.data){const v=n.data.data;console.log("从API响应获取的更新后用户信息:",v),I(v),f.success("基本资料更新成功")}else try{const v=await S.getUserInfo(d);if(v&&v.data&&v.data.data){const w=v.data.data;console.log("从服务器获取的最新用户信息:",w),I(w),f.success("基本资料更新成功")}else{const y={...JSON.parse(localStorage.getItem("user")||"{}"),...l};I(y),f.success("基本资料已更新，但获取最新数据失败")}}catch(v){console.error("获取最新用户信息失败:",v);const y={...JSON.parse(localStorage.getItem("user")||"{}"),...l};I(y),f.success("基本资料已更新，但获取最新数据失败")}setTimeout(()=>{window.location.reload()},1500)}else{const v=((e=n.data)==null?void 0:e.msg)||"更新失败，请稍后再试";f.error(v)}}catch(n){console.error("更新用户信息出错:",n),f.error("更新个人资料失败，请稍后再试"),n.response&&(console.error("错误响应状态:",n.response.status),console.error("错误响应数据:",n.response.data))}finally{i.value=!1}}})}catch(o){console.error("表单验证错误:",o),i.value=!1}},b=()=>{var o;(o=u.value)==null||o.resetFields()};return s({setFormData:o=>{o&&Object.keys(r).forEach(e=>{o[e]!==void 0&&(e==="gender"&&o[e]!==null?r[e]=parseInt(o[e]):e==="id"&&o[e]?r[e]=String(o[e]):r[e]=o[e])})},updateBasicInfo:V,resetBasicForm:b,basicForm:r}),(o,e)=>{const d=p("el-input"),l=p("el-form-item"),n=p("el-radio"),v=p("el-radio-group"),w=p("el-date-picker"),y=p("el-option"),R=p("el-select"),M=p("el-button"),q=p("el-form");return P(),k("div",G,[e[16]||(e[16]=c("h3",{class:"section-title"},"基本资料",-1)),a(q,{ref_key:"basicFormRef",ref:u,model:r,rules:x,"label-width":"100px",class:"profile-form"},{default:t(()=>[a(l,{label:"用户名",prop:"username"},{default:t(()=>[a(d,{modelValue:r.username,"onUpdate:modelValue":e[0]||(e[0]=m=>r.username=m),disabled:""},null,8,["modelValue"]),e[10]||(e[10]=c("div",{class:"form-tip"},"用户名不可修改",-1))]),_:1,__:[10]}),a(l,{label:"昵称",prop:"nickname"},{default:t(()=>[a(d,{modelValue:r.nickname,"onUpdate:modelValue":e[1]||(e[1]=m=>r.nickname=m),placeholder:"请输入昵称",maxlength:"20","show-word-limit":""},null,8,["modelValue"])]),_:1}),a(l,{label:"邮箱",prop:"email"},{default:t(()=>[a(d,{modelValue:r.email,"onUpdate:modelValue":e[2]||(e[2]=m=>r.email=m),placeholder:"请输入邮箱"},null,8,["modelValue"])]),_:1}),a(l,{label:"手机号",prop:"phone"},{default:t(()=>[a(d,{modelValue:r.phone,"onUpdate:modelValue":e[3]||(e[3]=m=>r.phone=m),placeholder:"请输入手机号"},null,8,["modelValue"])]),_:1}),a(l,{label:"性别"},{default:t(()=>[a(v,{modelValue:r.gender,"onUpdate:modelValue":e[4]||(e[4]=m=>r.gender=m)},{default:t(()=>[a(n,{label:1},{default:t(()=>e[11]||(e[11]=[h("男")])),_:1,__:[11]}),a(n,{label:0},{default:t(()=>e[12]||(e[12]=[h("女")])),_:1,__:[12]}),a(n,{label:2},{default:t(()=>e[13]||(e[13]=[h("保密")])),_:1,__:[13]})]),_:1},8,["modelValue"])]),_:1}),a(l,{label:"生日"},{default:t(()=>[a(w,{modelValue:r.birthday,"onUpdate:modelValue":e[5]||(e[5]=m=>r.birthday=m),type:"date",placeholder:"选择生日","value-format":"YYYY-MM-DD"},null,8,["modelValue"])]),_:1}),a(l,{label:"学校",prop:"school"},{default:t(()=>[a(d,{modelValue:r.school,"onUpdate:modelValue":e[6]||(e[6]=m=>r.school=m),placeholder:"请输入学校名称"},null,8,["modelValue"])]),_:1}),a(l,{label:"专业",prop:"major"},{default:t(()=>[a(d,{modelValue:r.major,"onUpdate:modelValue":e[7]||(e[7]=m=>r.major=m),placeholder:"请输入专业名称"},null,8,["modelValue"])]),_:1}),a(l,{label:"年级"},{default:t(()=>[a(R,{modelValue:r.grade,"onUpdate:modelValue":e[8]||(e[8]=m=>r.grade=m),placeholder:"请选择年级"},{default:t(()=>[a(y,{label:"大一",value:"大一"}),a(y,{label:"大二",value:"大二"}),a(y,{label:"大三",value:"大三"}),a(y,{label:"大四",value:"大四"}),a(y,{label:"研一",value:"研一"}),a(y,{label:"研二",value:"研二"}),a(y,{label:"研三",value:"研三"}),a(y,{label:"博士",value:"博士"})]),_:1},8,["modelValue"])]),_:1}),a(l,{label:"个人简介"},{default:t(()=>[a(d,{modelValue:r.biography,"onUpdate:modelValue":e[9]||(e[9]=m=>r.biography=m),type:"textarea",rows:4,placeholder:"介绍一下自己吧...",maxlength:"200","show-word-limit":""},null,8,["modelValue"])]),_:1}),a(l,null,{default:t(()=>[a(M,{type:"primary",onClick:V,loading:i.value},{default:t(()=>e[14]||(e[14]=[h(" 保存修改 ")])),_:1,__:[14]},8,["loading"]),a(M,{onClick:b},{default:t(()=>e[15]||(e[15]=[h("重置")])),_:1,__:[15]})]),_:1})]),_:1},8,["model"])])}}},Q=F(K,[["__scopeId","data-v-bf260e9a"]]);const X={class:"card"},ee={class:"avatar-section"},ae={class:"current-avatar"},oe={class:"avatar-upload"},re={class:"avatar-presets"},se={class:"preset-avatars"},te=["onClick"],le={__name:"AvatarSetting",props:{userAvatar:{type:String,default:""},userNickname:{type:String,default:""}},emits:["update:avatar"],setup(_,{emit:s}){const u=s,i=U([{id:1,url:"https://via.placeholder.com/120/4f46e5/ffffff?text=A"},{id:2,url:"https://via.placeholder.com/120/06b6d4/ffffff?text=B"},{id:3,url:"https://via.placeholder.com/120/10b981/ffffff?text=C"},{id:4,url:"https://via.placeholder.com/120/f59e0b/ffffff?text=D"},{id:5,url:"https://via.placeholder.com/120/ef4444/ffffff?text=E"},{id:6,url:"https://via.placeholder.com/120/8b5cf6/ffffff?text=F"}]),r=b=>{const g=b.type.startsWith("image/"),o=b.size/1024/1024<2;return g?o?!0:(f.error("图片大小不能超过2MB!"),!1):(f.error("只能上传图片文件!"),!1)},x=b=>{f.success("头像上传成功"),u("update:avatar","https://via.placeholder.com/120/8b5cf6/ffffff?text=NEW")},V=b=>{u("update:avatar",b),f.success("头像设置成功")};return(b,g)=>{const o=p("el-avatar"),e=p("el-icon"),d=p("el-button"),l=p("el-upload");return P(),k("div",X,[g[3]||(g[3]=c("h3",{class:"section-title"},"头像设置",-1)),c("div",ee,[c("div",ae,[a(o,{size:120,src:_.userAvatar},{default:t(()=>{var n;return[h(O((n=_.userNickname)==null?void 0:n.charAt(0)),1)]}),_:1},8,["src"]),g[0]||(g[0]=c("div",{class:"avatar-info"},[c("p",null,"当前头像"),c("span",{class:"avatar-tip"},"建议使用正方形图片，大小不超过2MB")],-1))]),c("div",oe,[a(l,{action:"#","show-file-list":!1,"before-upload":r,"on-success":x,accept:"image/*"},{default:t(()=>[a(d,{type:"primary"},{default:t(()=>[a(e,null,{default:t(()=>[a(C(z))]),_:1}),g[1]||(g[1]=h(" 上传新头像 "))]),_:1,__:[1]})]),_:1}),c("div",re,[g[2]||(g[2]=c("p",null,"或选择默认头像",-1)),c("div",se,[(P(!0),k(L,null,J(i.value,n=>(P(),k("div",{key:n.id,class:"preset-avatar",onClick:v=>V(n.url)},[a(o,{size:60,src:n.url},null,8,["src"])],8,te))),128))])])])])])}}},ne=F(le,[["__scopeId","data-v-c4a16cf2"]]);const de={class:"card"},ue={__name:"PasswordChange",setup(_){const s=U(),u=U(!1),i=N({currentPassword:"",newPassword:"",confirmPassword:""}),r=o=>{console.log("当前密码输入:",o)},V={currentPassword:[{required:!0,message:"请输入当前密码",trigger:"blur"}],newPassword:[{required:!0,message:"请输入新密码",trigger:"blur"},{pattern:/^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)[a-zA-Z\d@$!%*?&]{8,20}$/,message:"密码必须包含大小写字母和数字，长度8-20位",trigger:"blur"}],confirmPassword:[{required:!0,message:"请确认新密码",trigger:"blur"},{validator:(o,e,d)=>{e!==i.newPassword?d(new Error("两次输入的密码不一致")):d()},trigger:"blur"}]},b=async()=>{s.value&&await s.value.validate(async o=>{if(o)try{u.value=!0;const e=B();if(!e||!e.username){f.error("无法获取当前用户信息，请重新登录");return}console.log("当前用户信息:",e),console.log("表单数据:",i);const d={oldPassword:i.currentPassword,newPassword:i.newPassword};console.log("准备发送的密码数据:",d);try{const l=await S.changePassword(e.username,d);console.log("密码修改响应:",l),l.code===200?(f.success("密码修改成功"),g()):f.error(l.message||"密码修改失败")}catch(l){if(console.error("API调用错误:",l),l.response&&l.response.data){const n=l.response.data;f.error(n.message||"密码修改失败"),console.error("服务器错误:",n)}else f.error(l.message||"修改密码失败，请稍后重试")}}catch(e){console.error("修改密码失败:",e),e.response&&e.response.data?(console.error("服务器返回的错误:",e.response.data),f.error(e.response.data.message||"修改密码失败，请检查输入")):f.error(e.message||"修改密码失败，请稍后重试")}finally{u.value=!1}})},g=()=>{var o;(o=s.value)==null||o.resetFields()};return(o,e)=>{const d=p("el-input"),l=p("el-form-item"),n=p("el-button"),v=p("el-form");return P(),k("div",de,[e[5]||(e[5]=c("h3",{class:"section-title"},"修改密码",-1)),a(v,{ref_key:"passwordFormRef",ref:s,model:i,rules:V,"label-width":"100px",class:"password-form"},{default:t(()=>[a(l,{label:"当前密码",prop:"currentPassword"},{default:t(()=>[a(d,{modelValue:i.currentPassword,"onUpdate:modelValue":e[0]||(e[0]=w=>i.currentPassword=w),type:"password",placeholder:"请输入当前密码","show-password":"",onInput:r},null,8,["modelValue"])]),_:1}),a(l,{label:"新密码",prop:"newPassword"},{default:t(()=>[a(d,{modelValue:i.newPassword,"onUpdate:modelValue":e[1]||(e[1]=w=>i.newPassword=w),type:"password",placeholder:"请输入新密码","show-password":""},null,8,["modelValue"])]),_:1}),a(l,{label:"确认密码",prop:"confirmPassword"},{default:t(()=>[a(d,{modelValue:i.confirmPassword,"onUpdate:modelValue":e[2]||(e[2]=w=>i.confirmPassword=w),type:"password",placeholder:"请再次输入新密码","show-password":""},null,8,["modelValue"])]),_:1}),a(l,null,{default:t(()=>[a(n,{type:"primary",onClick:b,loading:u.value},{default:t(()=>e[3]||(e[3]=[h(" 修改密码 ")])),_:1,__:[3]},8,["loading"]),a(n,{onClick:g},{default:t(()=>e[4]||(e[4]=[h("重置")])),_:1,__:[4]})]),_:1})]),_:1},8,["model"])])}}},ie=F(ue,[["__scopeId","data-v-c2be8936"]]);const ce={class:"profile-container"},pe={class:"container"},fe={class:"profile-wrapper"},me={class:"profile-sidebar"},_e={class:"card"},ge={class:"profile-main"},ve={__name:"index",setup(_){const s=U("basic"),u=U(null),i=U(!1),r=N({id:"",username:"",nickname:"",email:"",avatar:"",phone:"",gender:2,birthday:"",school:"",major:"",grade:"",biography:""}),x=o=>{s.value=o,o==="basic"&&$(()=>{g()})},V=async o=>{if(r.username)try{await S.updateAvatar(r.username,o),r.avatar=o;const e=B()||{};e.avatar=o,I(e),f.success("头像更新成功")}catch(e){console.error("更新头像出错:",e),f.error(e.message||"头像更新失败，请稍后再试")}},b=()=>{const o=B();return o?(o.username==="orenge"&&(o.id="1934906330905174017",console.log("从本地存储加载时，修正orenge用户ID:",o.id)),Object.assign(r,o),$(()=>{u.value&&s.value==="basic"&&u.value.setFormData(r)}),!0):!1},g=async()=>{try{i.value=!0;const o=await S.getCurrentUser();console.log("获取当前用户信息响应:",o);let e=null;return o&&o.data&&(o.data.code===200&&o.data.data?e=o.data.data:o.data.id&&(e=o.data)),e?(console.log("获取到的用户数据:",e),e.username==="orenge"&&(e.id="1934906330905174017",console.log("检测到orenge用户，固定使用正确ID:",e.id)),Object.assign(r,e),I(e),$(()=>{if(u.value&&s.value==="basic"){const d=JSON.parse(JSON.stringify(r));u.value.setFormData(d)}}),!0):!1}catch(o){return console.error("获取用户信息出错:",o),b()||f.error("获取用户信息失败"),!1}finally{i.value=!1}};return Y(s,o=>{o==="basic"&&$(()=>{u.value&&u.value.setFormData(r)})}),T(()=>{b(),g()}),(o,e)=>{const d=p("el-icon"),l=p("el-menu-item"),n=p("el-menu"),v=p("el-main");return P(),k("div",ce,[a(H),a(v,{class:"main-content"},{default:t(()=>[c("div",pe,[c("div",fe,[c("div",me,[c("div",_e,[a(n,{"default-active":s.value,onSelect:x,class:"profile-menu"},{default:t(()=>[a(l,{index:"basic"},{default:t(()=>[a(d,null,{default:t(()=>[a(C(D))]),_:1}),e[0]||(e[0]=c("span",null,"基本资料",-1))]),_:1,__:[0]}),a(l,{index:"avatar"},{default:t(()=>[a(d,null,{default:t(()=>[a(C(W))]),_:1}),e[1]||(e[1]=c("span",null,"头像设置",-1))]),_:1,__:[1]}),a(l,{index:"password"},{default:t(()=>[a(d,null,{default:t(()=>[a(C(Z))]),_:1}),e[2]||(e[2]=c("span",null,"修改密码",-1))]),_:1,__:[2]})]),_:1},8,["default-active"])])]),c("div",ge,[s.value==="basic"?(P(),j(Q,{key:0,ref_key:"basicInfoRef",ref:u},null,512)):E("",!0),s.value==="avatar"?(P(),j(ne,{key:1,"user-avatar":r.avatar,"user-nickname":r.nickname,"onUpdate:avatar":V},null,8,["user-avatar","user-nickname"])):E("",!0),s.value==="password"?(P(),j(ie,{key:2})):E("",!0)])])])]),_:1})])}}},he=F(ve,[["__scopeId","data-v-83a3f54d"]]);export{he as default};
